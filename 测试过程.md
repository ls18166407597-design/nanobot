# Nanobot 系统测试与验证全过程

## 概述
我们实施了一项全面的系统加固策略，旨在解决静默失败问题并显著提高系统的可观测性。目前的 Nanobot 已具备“故障安全 (Fail-Safe)”机制，并且所有操作均可全链路追踪。

## 关键改进

### 1. 端到端追踪 (TraceID)
- **功能**: 每条消息现在都携带一个唯一的 `trace_id`。
- **价值**: 支持通过日志快速定位请求路径，实现全链路排障。

### 2. 自动化系统审计 (AI Audit Skill V2)
- **升级**: 根据反馈，测试技能已升级为 **AI 助手审计专用版 (V2)**。
- **核心**: `regression_suite.py` 可输出详细的 JSON 格式报告。
- **闭环**: 专供 AI 助手在修改代码后进行自检，确保不留隐患。

### 3. 环境与依赖加固
- **彻底本地化**: 删除了 `~/.nanobot` 等外部依赖。
- **视觉驱动固化**: 集成 `pyobjc`，使 macOS 的视觉感知能力更加稳健。

---

## 测试阶段回顾

### Phase 12: 全功能全链路压力测试
模拟真实用户指令，对核心能力进行了分阶段测试：
- **基础能力 (Foundation)**:
  - ✅ **身份识别**: 正确响应 `SOUL.md`。
  - ✅ **文件操作**: 解决了多指令解析冲突。
  - ✅ **系统控制**: `top`, `uname` 获取成功。
- **信息集成 (Connectivity)**:
  - ✅ **联网搜索**: 实时获取 iPhone 16 详情。
  - ✅ **Gmail 协作**: 成功拉取最新邮件。
  - ✅ **GitHub 动态**: 准确获取 GitHub 活动。
- **高级感知 (Perception)**:
  - ✅ **视野感知**: 成功分析屏幕窗口内容。
  - ✅ **自动化审计**: 成功触发技能自检。

### Phase 13: 极限多智能体压力测试
编排了一个“秘书 (Secretary)”智能体来并发协调三个子智能体，验证系统韧性。
- **状态**: 编排成功
- **验证点**:
    - **并发生成**: 验证了 3 个智能体并行的生命周期管理。
    - **TraceID 审计**: 确认 TraceID 在子智能体间 100% 继承。
    - **故障转移**: 秘书在子智能体超时的情况下保持了自身的活跃。

### Phase 14: 综合深度功能验证
执行了 4 项超越简单 CLI 命令的深度测试，验证真实场景下的健壮性。
- **状态**: 100% 成功
- **亮点**:
    - **macOS 视觉**: 通过原生 Vision 框架成功识别屏幕上的 124 个文本块。
    - **GitHub 协同**: 验证了提交记录拉取路径的 100% 准确性。
    - **RAG 与记忆**: 确认了技术洞察的持久化存储与语义召回。
    - **网页浏览**: 验证了在 GitHub 公共仓库等复杂 UI 下的处理能力。

### Phase 15: 自适应环境感知 (Stage Manager 兼容)
重构了核心感知逻辑，绕过了不稳定的 macOS 辅助功能权限问题。
- **状态**: 100% 成功 (基于 Quartz 引擎)
- **亮点**:
    - **无需权限**: 从 AppleScript 切换到 Quartz C-API 获取窗口 ID，彻底解决了 TCC `-25211` 错误。
    - **台前调度兼容**: 验证了 Nanobot 可以在开启台前调度 (Stage Manager) 时准确识别并“注视”目标窗口，不受背景噪声干扰。
    - **进程无关**: 成功处理了进程名与窗口所有者不一致的情况 (如 Electron 应用)。

### Phase 16: 极限技术协同与用户视角验证
全频谱的协同测试，专注于细颗粒度的工具链闭环。
- **状态**: 100% 成功
- **亮点**:
    - **Gmail 优化**: 确认了邮件状态 (总数/未读) 及列表功能的完美运行。
    - **洞察闭环**: 验证了 [GitHub 提交] -> [记忆洞察] -> [Gmail 状态] 这一跨工具链的数据合成能力。
    - **极限健壮性**: 在所有主要工具中成功拦截了空查询和无效实体 ID 等异常。

### Phase 17: 极限 UI 交互验证 (桌面自动化重构)
桌面 UI 自动化互动的里程碑，重点攻克了输入法干扰和搜索定位问题。
- **状态**: 100% 成功 (纯键盘流方案)
- **验证场景**:
    - **WeChat (微信)**: 成功给“小号”发送消息。
    - **Telegram**: 成功给 "MyJarvis" 发送消息。
- **成功路径 (Pure Keyboard Flow)**:
    1.  **激活应用**: 将目标 App (WeChat/Telegram) 调度至前台。
    2.  **聚焦搜索**: 使用 App 快捷键 (`Cmd+F` / `Cmd+K`)。
    3.  **粘贴搜索词**: 使用 `Cmd+V` 粘贴精确的联系人名称 (避开输入法)。
    4.  **等待索引**:以此为关键，等待 1.5秒让搜索结果加载。
    5.  **回车选择**: `Enter` 打开首个结果。
    6.  **等待切窗**: 等待 1.0秒让焦点进入聊天窗口。
    7.  **发送消息**: 粘贴内容 -> `Enter` 发送。

### Phase 20: 综合验证与清理
完成了生产环境的定型，并归档了标准操作程序 (SOP)。

#### 清理与维护
执行了清理脚本 `scripts/cleanup_all.sh`，移除了所有临时测试产物，并对代码库进行了标准化整理：
- **生产脚本**: `scripts/*.py` (包含智能分发、联系人管理、执行器)
- **验证测试**: `scripts/verification/*.py` (集成测试、验证脚本)
- **诊断工具**: `scripts/diagnostics/*.py` (系统体检)
- **归档**: `scripts/archive/` (旧代码)

---

## 全项目测试 SOP (标准操作程序)

为了确保在发布新版本或重大变更前系统的稳定性，请遵循以下测试层级：

### 1. 系统健康检查 (诊断层)
首先运行这些脚本，确保基础环境健康。
```bash
python3 scripts/diagnostics/diagnostic_windows.py  # 检查窗口感知能力
python3 scripts/diagnostics/diagnostic_quartz.py   # 检查底层窗口 API
```

### 2. 集成验证 (功能层)
运行这些脚本，验证 Agent 的核心能力。
```bash
python3 scripts/verification/verify_system.py      # 全系统通用检查
python3 scripts/verification/test_vision.py        # 验证视觉工具
python3 scripts/verification/test_gmail.py         # 验证 Gmail 集成
```

### 3. 桌面自动化 (端到端 UI 层)
运行此流程，验证对 WeChat / Telegram 的控制能力。

**步骤 A: 添加测试联系人**
```bash
python3 scripts/manage_contacts.py add "test_bot" "MyJarvis" Telegram
```

**步骤 B: 发送测试消息**
```bash
python3 scripts/smart_send.py "test_bot" "SOP 验证测试消息"
```

**步骤 C: 清理测试数据**
```bash
python3 scripts/manage_contacts.py remove "test_bot"
```

### 4. 全量回归 (可选)
如果修改了 Agent 的核心逻辑：
```bash
python3 scripts/verification/stress_test.py
```
