# Nanobot 项目结构说明

这是当前项目的目录布局、分层职责与文档标准。

## 文档目标

1. 标准化：同一类信息只在一个固定位置维护。  
2. 可读性：先看导航，再看明细，避免信息淹没。  
3. 可维护：新增文件时有明确更新入口，不靠记忆。

## 目录结构

```text
nanobot/
├── nanobot/                 # 内核源码
│   ├── agent/               # 代理编排与执行引擎
│   ├── channels/            # 通道接入（Telegram 等）
│   ├── cli/                 # CLI 命令（config/doctor/health/stop/restart）
│   ├── session/             # 会话管理与服务
│   └── tests/               # 核心测试
│
├── workspace/               # 工作区（可定制）
│   ├── AGENTS.md
│   ├── IDENTITY.md
│   ├── TOOLS.md
│   ├── scripts/
│   └── memory/
│
├── .home/                   # 运行时数据（由 NANOBOT_HOME 指定）
│   ├── config.json
│   ├── gateway.log
│   ├── audit.log
│   └── sessions/
│
├── scripts/
│   ├── run_gateway.sh       # 推荐启动入口
│   └── smoke_regression.py  # 5 场景回归脚本
│
├── docs/
├── ARCHITECTURE.md
└── README.md
```

## 核心组件

| 组件 | 作用 | 典型改动场景 |
| :--- | :--- | :--- |
| `nanobot/agent/loop.py` | 主编排层（路由与生命周期） | 调整主流程边界 |
| `nanobot/agent/turn_engine.py` | 单回合执行状态机（含工具预算与强制总结） | 调整工具循环、预算上限、超限收敛策略 |
| `nanobot/agent/user_turn_service.py` | 用户消息回合处理 | 调整用户消息持久化与回包 |
| `nanobot/agent/system_turn_service.py` | 系统消息回合处理 | 调整 system/origin 回包行为 |
| `nanobot/agent/message_flow.py` | lane/busy/error 路由协调 | 调整并发与繁忙提示策略 |
| `ARCHITECTURE.md` | 架构契约与变更门禁 | 调整分层规则 |

## 近期核心更新（2026-02-11）

1. `turn_engine` 增加工具预算控制，避免开放式视觉任务无上限探索：  
   - 总工具调用上限：8  
   - `mac_vision` 上限：3  
   - `exec` 上限：3  
2. 当预算超限或回合到达上限时，`turn_engine` 强制输出执行摘要，不再返回空结果。  
3. Telegram 盲切任务脚本修复父子进程锁冲突：父任务持锁、子脚本支持 `--skip-lock`，避免“只打开应用不执行后续动作”。

## 目录优化空间（当前建议）

1. `docs/` 分层：将“架构文档”和“运维文档”拆成子目录（如 `docs/architecture/`、`docs/ops/`），降低检索成本。  
2. `workspace/scripts/` 分层：按域拆分（如 `telegram/`、`wechat/`、`mail/`），避免脚本平铺。  
3. `skills` 双轨治理：保留 `nanobot/library/skills/`（内置）与 `workspace/skills/`（业务定制）的边界，不混放。  
4. 文档索引统一：`docs/项目结构.md` 做“导航页”，详细清单放到专门文件，避免单文档过长。  
5. 变更门禁：核心路径（`nanobot/agent/`、`nanobot/providers/`）建议继续保持“先测试后合并”的门禁。

## 文件清单

- 全量文件路径与用途说明见：`docs/文件清单.md`

## 文档标准（统一口径）

1. `docs/项目结构.md`：只做导航、分层职责、维护规则。  
2. `docs/文件清单.md`：只做“文件路径 -> 用途”全量索引，不放流程性说明。  
3. `ARCHITECTURE.md`：只定义核心架构契约与边界，不放业务脚本细节。  
4. `docs/配置指南.md`：只放配置与运行方式，不放代码结构说明。  

## 维护规则（落地）

1. 新增或删除仓库文件时，同步更新 `docs/文件清单.md`。  
2. 核心目录职责变化时，同步更新 `docs/项目结构.md` 和 `ARCHITECTURE.md`。  
3. 提交前检查：确保“导航文档”和“全量清单”没有互相冲突。  

## 说明

- `workspace/` 用于业务规则与定制内容。  
- `.home/` 用于运行时配置和状态数据。  
- 核心改造优先遵循 `ARCHITECTURE.md` 中的契约与测试门禁。  
