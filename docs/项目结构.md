# Nanobot 项目结构说明

这是当前项目的目录布局、分层职责与文档标准。

文档入口建议先看：`docs/文档导航.md`。

## 文档目标

1. 标准化：同一类信息只在一个固定位置维护。  
2. 可读性：先看导航，再看明细，避免信息淹没。  
3. 可维护：新增文件时有明确更新入口，不靠记忆。

## 目录结构

```text
nanobot/
├── nanobot/                 # 内核源码
│   ├── agent/               # 代理编排与执行引擎
│   ├── channels/            # 通道接入（Telegram 等）
│   ├── cli/                 # CLI 命令（config/doctor/health/stop/restart）
│   ├── session/             # 会话管理与服务
│   └── tests/               # 核心测试
│
├── workspace/               # 工作区（可定制）
│   ├── AGENTS.md
│   ├── IDENTITY.md
│   ├── TOOLS.md
│   ├── scripts/
│   └── memory/
│
├── .home/                   # 运行时数据（由 NANOBOT_HOME 指定）
│   ├── config.json
│   ├── gateway.log
│   ├── audit.log
│   └── sessions/
│
├── scripts/
│   ├── run_gateway.sh       # 推荐启动入口
│   └── smoke_regression.py  # 5 场景回归脚本
│
├── docs/
├── ARCHITECTURE.md
└── README.md
```

## 核心组件

| 组件 | 作用 | 典型改动场景 |
| :--- | :--- | :--- |
| `nanobot/agent/loop.py` | 主编排层（路由与生命周期） | 调整主流程边界 |
| `nanobot/agent/turn_engine.py` | 单回合执行状态机（含工具预算与强制总结） | 调整工具循环、预算上限、超限收敛策略 |
| `nanobot/agent/user_turn_service.py` | 用户消息回合处理 | 调整用户消息持久化与回包 |
| `nanobot/agent/system_turn_service.py` | 系统消息回合处理 | 调整 system/origin 回包行为 |
| `nanobot/agent/message_flow.py` | lane/busy/error 路由协调 | 调整并发与繁忙提示策略 |
| `ARCHITECTURE.md` | 架构契约与变更门禁 | 调整分层规则 |

## 提示词装配口径

1. `workspace/IDENTITY.md`：作为身份主提示词模板，由 `nanobot/agent/context.py` 动态注入运行时变量（时间、模型、工作区、工具配置状态等）。  
2. `workspace/AGENTS.md`、`workspace/USER.md`、`workspace/TOOLS.md`：作为静态规则与策略文档按顺序拼接。  
3. `SOUL.md` 已合并到 `IDENTITY.md` 口径，不再作为单独注入源。

## 近期核心更新（2026-02-11）

1. `turn_engine` 采用总预算控制，默认总工具调用上限为 30（可通过配置调整）。  
2. 预算超限或回合到达上限时，`turn_engine` 进入强制收敛路径，优先让模型基于已有结果给出最终总结。  
3. 新增通用参数澄清守卫：对地点/路线等上下文敏感任务先澄清再执行，减少错误默认值。  
4. 提示词体系收口：`IDENTITY.md` 作为身份模板统一管理，`SOUL.md` 不再单独注入。

## 近期核心更新（2026-02-13）

1. 新增 `IncidentManager`：统一故障事件分级、去重、升级判定与持久化。  
2. 执行真值校验：`turn_engine` 产出执行报告，`user_turn_service` 回包前纠正“已完成”类误导话术。  
3. 任务稳定性增强：`task` 在 create/update 阶段执行前置校验，减少“保存成功但运行失败”的延迟故障。  
4. 新增运行态清理能力：`system_status.reset_runtime`（需 `confirm=true`）用于无污染重测。  

## 目录优化空间（当前建议）

1. `docs/` 分层：将“架构文档”和“运维文档”拆成子目录（如 `docs/architecture/`、`docs/ops/`），降低检索成本。  
2. `workspace/scripts/` 分层：按域拆分（如 `telegram/`、`wechat/`、`mail/`），避免脚本平铺。  
3. `skills` 单层治理：统一使用 `workspace/skills/`，避免来源混乱与重复说明。  
4. 文档索引统一：`docs/项目结构.md` 做“导航页”，详细清单放到专门文件，避免单文档过长。  
5. 变更门禁：核心路径（`nanobot/agent/`、`nanobot/providers/`）建议继续保持“先测试后合并”的门禁。

## 技能口径（当前）

1. 技能目录统一为：`workspace/skills/`。  
2. 业务技能、流程技能、运维技能都放在该目录，按子目录区分。  
3. 已移除多层技能来源口径，避免解释成本和优先级歧义。

## 会话存储口径

- 目录：`.home/sessions/`
- 主会话命名：`telegram_<chat_id>#main.jsonl`
- 分支会话命名：`telegram_<chat_id>#sYYYYMMDD_HHMMSS_<id>.jsonl`
- Telegram 支持 `/undo` 回退上一轮对话（通过创建回退副本并切换实现）。

## 运行态清理口径

- 可清理：`.home/sessions/`、`.home/runtime/failures.json`、`.home/gateway.log`、`.home/audit.log`  
- 默认保留：`.home/config.json`、`.home/tasks.json`、`.home/tool_configs/`  
- 推荐入口：`system_status` 工具的 `reset_runtime` 动作（显式确认后执行）。  

## 文件清单

- 全量文件路径与用途说明见：`docs/文件清单.md`

## 文档标准（统一口径）

1. `docs/项目结构.md`：只做导航、分层职责、维护规则。  
2. `docs/文件清单.md`：只做“文件路径 -> 用途”全量索引，不放流程性说明。  
3. `ARCHITECTURE.md`：只定义核心架构契约与边界，不放业务脚本细节。  
4. `docs/配置指南.md`：只放配置与运行方式，不放代码结构说明。  

## 维护规则（落地）

1. 新增或删除仓库文件时，同步更新 `docs/文件清单.md`。  
2. 核心目录职责变化时，同步更新 `docs/项目结构.md` 和 `ARCHITECTURE.md`。  
3. 提交前检查：确保“导航文档”和“全量清单”没有互相冲突。  

## 说明

- `workspace/` 用于业务规则与定制内容。  
- `.home/` 用于运行时配置和状态数据。  
- 核心改造优先遵循 `ARCHITECTURE.md` 中的契约与测试门禁。  
