# Nanobot 项目结构说明

这是当前项目的核心目录布局与分层职责。

## 目录结构

```text
nanobot/
├── nanobot/                 # 内核源码
│   ├── agent/               # 代理编排与执行引擎
│   ├── channels/            # 通道接入（Telegram 等）
│   ├── cli/                 # CLI 命令（config/doctor/health/stop/restart）
│   ├── session/             # 会话管理与服务
│   └── tests/               # 核心测试
│
├── workspace/               # 工作区（可定制）
│   ├── AGENTS.md
│   ├── IDENTITY.md
│   ├── TOOLS.md
│   ├── scripts/
│   └── memory/
│
├── .home/                   # 运行时数据（由 NANOBOT_HOME 指定）
│   ├── config.json
│   ├── gateway.log
│   ├── audit.log
│   └── sessions/
│
├── scripts/
│   ├── run_gateway.sh       # 推荐启动入口
│   └── smoke_regression.py  # 5 场景回归脚本
│
├── docs/
├── ARCHITECTURE.md
└── README.md
```

## 核心组件

| 组件 | 作用 | 典型改动场景 |
| :--- | :--- | :--- |
| `nanobot/agent/loop.py` | 主编排层（路由与生命周期） | 调整主流程边界 |
| `nanobot/agent/turn_engine.py` | 单回合执行状态机 | 调整工具循环、循环检测 |
| `nanobot/agent/user_turn_service.py` | 用户消息回合处理 | 调整用户消息持久化与回包 |
| `nanobot/agent/system_turn_service.py` | 系统消息回合处理 | 调整 system/origin 回包行为 |
| `nanobot/agent/message_flow.py` | lane/busy/error 路由协调 | 调整并发与繁忙提示策略 |
| `ARCHITECTURE.md` | 架构契约与变更门禁 | 调整分层规则 |

## 说明

- `workspace/` 用于业务规则与定制内容。
- `.home/` 用于运行时配置和状态数据。
- 核心改造优先遵循 `ARCHITECTURE.md` 中的契约与测试门禁。
