# Nanobot 配置指南

本指南说明配置文件位置、常用管理命令，以及“机器人是否能修改配置”。

## 基础命令

- 查看配置：`nanobot config list`
- 设置配置项：`nanobot config set agents.defaults.model "gemini-3-flash"`
- 设置单轮工具调用上限：`nanobot config set brain.max_total_tool_calls 30`
- 设置单轮处理超时（秒）：`nanobot config set brain.max_turn_seconds 45`
- 设置系统默认时区：`nanobot config set brain.timezone "Asia/Shanghai"`
- 设置繁忙提示阈值：`nanobot config set tools.busy_notice_threshold 2`
- 设置繁忙提示去抖（秒）：`nanobot config set tools.busy_notice_debounce_seconds 120`
- 设置 Exec 执行模式：`nanobot config set tools.exec.mode "host"`（可选：`sandbox`、`hybrid`）
- 设置 Exec 沙箱引擎：`nanobot config set tools.exec.sandbox_engine "auto"`（可选：`bwrap`、`docker`）
- 设置 MCP 启动超时（秒）：`nanobot config set tools.mcp.startup_timeout 8`
- 设置 MCP 请求超时（秒）：`nanobot config set tools.mcp.request_timeout 20`
- 设置联网默认入口：`nanobot config set tools.policy.web_default "tavily"`（可选：`browser`）
- 设置是否启用 MCP 失败回退（默认 false）：`nanobot config set tools.policy.enable_mcp_fallback true`
- 设置是否允许用户显式要求 MCP（默认 false）：`nanobot config set tools.policy.allow_explicit_mcp true`
- 配置意图路由规则：`nanobot config set tools.policy.intent_rules '[{"capability":"train_ticket","keywords":["12306","火车票"]}]'`
- 配置工具能力标签：`nanobot config set tools.policy.tool_capabilities '{"weather":["weather"],"github":["code_hosting"]}'`
- 配置体检：`nanobot doctor`
- 运行体检：`nanobot health`
- 工具健康看板：`nanobot tools-health`（指标：调用次数、失败率、超时率、空回复率）

## 配置文件位置

- 默认配置目录：`.home/`
- 默认配置文件：`.home/config.json`
- 默认日志文件：`.home/gateway.log`、`.home/audit.log`
- 工具配置目录：`.home/tool_configs/`

工具配置规则：

- 读取与写入都统一使用 `.home/tool_configs/`。
- MCP 配置文件：`.home/tool_configs/mcp_config.json`

`mcp_config.json` 示例：

```json
{
  "servers": {
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "/Users/liusong/Downloads/nanobot/workspace"],
      "enabled": true,
      "allowed_tools": ["read_file", "list_directory"],
      "startup_timeout": 8,
      "request_timeout": 20
    },
    "12306": {
      "command": "npx",
      "args": ["-y", "12306-mcp"],
      "enabled": true,
      "capabilities": ["train_ticket"]
    }
  }
}
```

GitHub MCP 最小示例：

```json
{
  "servers": {
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "enabled": true
    }
  }
}
```

说明：
- `github` 工具已切换为 MCP 后端。
- 可先执行 `github(action=\"setup\", setup_token=\"ghp_xxx\")` 保存 Token；
- 运行时若 `servers.github.env` 未设置 `GITHUB_TOKEN`，系统会自动使用 `github_config.json` 中保存的 token。
- `mcp` 工具仅在 `mcp_config.json` 里至少有一个启用的 server 时才会注册，避免工具列表混乱。

精简工具列表（推荐）：

```bash
nanobot config set tools.enabled_tools '["read_file","write_file","edit_file","list_dir","exec","browser","tavily","github","message","mac_control","mac_vision","task","skills","memory"]'
```

火车票能力建议启用 `train_ticket`（由工具内部调用 12306 MCP 后端）：

```bash
nanobot config set tools.enabled_tools '["read_file","write_file","edit_file","list_dir","exec","browser","tavily","github","train_ticket","message","mac_control","mac_vision","task","skills","memory"]'
```

也可以通过环境变量切换目录：

```bash
export NANOBOT_HOME="/path/to/data_dir"
nanobot gateway
```

## 推荐启动与运维命令

```bash
cd /Users/liusong/Downloads/nanobot
./scripts/run_gateway.sh
```

```bash
cd /Users/liusong/Downloads/nanobot
NANOBOT_HOME=$PWD/.home .venv/bin/nanobot stop
NANOBOT_HOME=$PWD/.home .venv/bin/nanobot restart
NANOBOT_HOME=$PWD/.home .venv/bin/nanobot health
```

## Cron 定时任务建议

- 建议创建 cron 时显式带上 `tz`，避免跨时区偏移：  
  `cron(action="add", task_name="每日邮件检查任务", cron_expr="0 9 * * *", tz="Asia/Shanghai")`
- 若只给 `cron_expr` 未给 `tz`，系统会使用 `brain.timezone` 作为默认时区。
- 使用 `task_name` 创建的 cron 任务会走 `task_run` 直连执行路径，不再先让模型“理解并再调用 task”，可显著降低循环与预算超限概率。

## 机器人能不能改 `.home/config.json`

可以，但要看运行上下文和权限。

- 在当前 Codex 开发会话中：可以直接修改（与仓库同机同目录权限）。
- 在 Nanobot 聊天通道中：通常也可以修改，但前提是工具权限允许访问 `.home/`。

关键条件：

- `tools.restrict_to_workspace = false` 时，工具不限制在 `workspace/`，可访问 `.home/`。
- `tools.restrict_to_workspace = true` 时，工具会限制在 `workspace/`，此时不能直接改 `.home/config.json`。

推荐做法：

- 优先使用 `nanobot config set ...` 修改配置，避免手写 JSON 造成格式错误。
- 需要批量改动时，再让机器人改 `config.json`，改完立即执行 `nanobot health` 校验。

## 相关文档

- [项目结构](项目结构.md)
- [路线图](路线图.md)

## Telegram 会话命令

- `/new`：新建会话（从空上下文开始）。
- `/history`：查看当前 chat 最近会话。
- `/use <session_key>`：切换到指定会话。
- `/clear`：清空当前会话并切到新会话。
- `/undo`：回退上一轮对话（删除最后一轮 user+assistant 等相关消息），并切换到回退后的会话副本。

## Sessions 命名规则

默认目录：`.home/sessions/`

- 主会话：`telegram_<chat_id>#main.jsonl`
- 分支/回退会话：`telegram_<chat_id>#sYYYYMMDD_HHMMSS_<id>.jsonl`

兼容迁移：

- 旧格式 `telegram_<chat_id>.jsonl` 会在读取时自动迁移为 `#main` 格式。
